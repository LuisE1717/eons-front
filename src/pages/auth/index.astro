---
import { getSession } from "auth-astro/server";
import Auth from "../../modules/user/aplication/Auth/Auth.astro";
import AppContainer from "../../layouts/AppContainer.astro";
import { singUp } from "../../utils/api/userApi";
import { getI18N } from "../../i18n";
import { setCookie } from "../../utils/cookies/Cookies";

if(Astro.cookies.get("eons_lng")?.value === 'es'){
    console.log('redicteing')
    return Astro.redirect('/es/auth')
 }

 const currentLocale  = Astro?.currentLocale || 'en'
const i18 = getI18N({currentLocale})

let token = ''

const session = await getSession(Astro.request)
  try {
    if(session?.user?.email){
        await singUp({email:session.user.email,password: import.meta.env.AUTH_SECRET})
       .then((response)=>{
        Astro.cookies.set('eons_token',response.data)
         Astro.cookies.set('eons_user',session?.user?.email || '')
         token=Astro.cookies.get('eons_token')?.value || '';
         console.log(token)
       })
       .catch(({response})=>{console.log(response)})
       if(token)
        return Astro.redirect('/',302)
  }
  else{
    Astro.cookies.delete('eons_token')
    Astro.cookies.delete('eons_user')
  }
  } catch (error) {
    console.log(error)
  }
---

<AppContainer>
    <Auth/>
</AppContainer>