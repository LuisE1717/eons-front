---
import { getSession } from "auth-astro/server";
import Auth from "../../modules/user/aplication/Auth/Auth.astro";
import AppContainer from "../../layouts/AppContainer.astro";
import { singUp } from "../../utils/api/userApi";
import { getExpire } from "../../utils/cookies/Cookies";
import { toast } from "react-toastify";
import { getI18N } from "../../i18n"

const locale = Astro.cookies.get("eons_lng")?.value || 'en'
const i18 = getI18N({ currentLocale:locale })

  try {
    const session = await getSession(Astro.request)
    let token = ''
    if(session?.user?.email){
        await singUp({email:session.user.email,password: import.meta.env.AUTH_SECRET})
       .then((response)=>{
         Astro.cookies.set('eons_token',response.data.accessToken,{expires: getExpire(),path:'/'})
         Astro.cookies.set('eons_user',session?.user?.email || '',{expires: getExpire(),path:'/'})
         token=Astro.cookies.get('eons_token')?.value || '';
         console.log(token)
       })
       .catch(({response})=>{console.log(response)})
       toast.error(i18.fecth_error)
       if(token)
        return Astro.redirect(`/services`,302)
  }
  else{
    Astro.cookies.delete('eons_token')
    Astro.cookies.delete('eons_user')
  }
  } catch (error) {
    console.log(error)
    toast.error(i18.fecth_error)
    //return Astro.redirect(`/auth`,302)
  }
---

<AppContainer>
    <Auth/>
</AppContainer>