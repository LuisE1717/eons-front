---
import AppContainer from "../../layouts/AppContainer.astro";
import type { INotifications } from "../../modules/Notifications/domain/INotifications";
import Services from '../../modules/Services/Services.astro'
import { getProfile } from "../../utils/api/userApi";
import { getExpire } from "../../utils/cookies/Cookies";
let readed = false;
const token = Astro.cookies.get('eons_token')?.value || '';
const email = Astro.cookies.get('eons_user')?.value || '';

if(token === ''){
    return Astro.redirect('/auth')
}
    

    var notificaciones: INotifications[] = []

try {
    const profile = await getProfile(token);

    readed = profile?.data.notificaciones.some(
  (notificacion) => notificacion.tipo === "readDocumentation"
);

    Astro.cookies.set('eons_essence',profile?.data?.essence || 0,{expires:getExpire(7),path:'/'})
    if(profile?.data?.notificaciones && profile?.data?.notificaciones?.length > 0)
        notificaciones = profile?.data?.notificaciones
} catch (error) {
    const status = error.response?.status || error.status || null;
    if(status === 401){
        Astro.cookies.delete('eons_token')
        Astro.cookies.delete('eons_user')
        return Astro.redirect('/auth')
    }else if(status === 403){
        return Astro.redirect(`/auth/email-verification/${Astro.cookies.get('eons_user')?.value || ''}`)
    }
}
---

<AppContainer>
    <Services notificaciones={notificaciones} first_time={!readed}/>
</AppContainer>